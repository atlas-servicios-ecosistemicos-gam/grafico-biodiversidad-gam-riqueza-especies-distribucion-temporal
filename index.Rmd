---
title: "Biodiversidad de la Gran Área Metropolitana"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
---

```{r setup, include=FALSE}
#-------------------- Paquetes --------------------

library(flexdashboard)
library(readr)
library(plotly)

#------------------- Constantes -------------------

# Año límite superior del periodo de datos a considerar
ANYO_LIMITE_SUPERIOR = "2000"

#--------------- URL de geoservicios --------------

url_csv_registros_presencia <-
  "https://raw.githubusercontent.com/atlas-servicios-ecosistemicos-gam/datos-biodiversidad/main/gam/gam-registros-presencia-chordata-plantae.csv"

#--------------- Objetos df ---------------

# Registros de presencia filtrados por rango taxonómico (>= SPECIES) y año
df_registros_presencia <- 
  readr::read_csv(url_csv_registros_presencia) %>%
  filter((taxonRank == "SPECIES" | taxonRank == "SUBSPECIES" | taxonRank == "VARIETY" | taxonRank == "FORM") & year >= ANYO_LIMITE_SUPERIOR)

# AVES
# Registros de presencia de aves
df_registros_presencia_aves <- 
  df_registros_presencia %>%
  filter(class == "Aves")

# Registros de presencia de aves agrupados por año
df_registros_presencia_aves_agrupados_por_anyo <-
  df_registros_presencia_aves %>%
  dplyr::count(year)

# Registros de presencia de aves agrupados por especie
df_registros_presencia_aves_agrupados_por_especie <-
  df_registros_presencia_aves %>%
  dplyr::count(species)

# Cantidad de registros de presencia de aves
registros_presencia_aves <- 
  nrow(df_registros_presencia_aves)

# Cantidad de especies de aves
especies_aves <-
  nrow(df_registros_presencia_aves_agrupados_por_especie)


# ANFIBIOS
# Registros de presencia de anfibios
df_registros_presencia_amphibia <- 
  df_registros_presencia %>%
  filter(class == "Amphibia")

# Registros de presencia de anfibios agrupados por año
df_registros_presencia_amphibia_agrupados_por_anyo <-
  df_registros_presencia_amphibia %>%
  dplyr::count(year)

# Registros de presencia de anfibios agrupados por especie
df_registros_presencia_amphibia_agrupados_por_especie <-
  df_registros_presencia_amphibia %>%
  dplyr::count(species)

# Cantidad de registros de presencia de anfibios
registros_presencia_amphibia <- 
  nrow(df_registros_presencia_amphibia)

# Cantidad de especies de anfibios
especies_amphibia <-
  nrow(df_registros_presencia_amphibia_agrupados_por_especie)

```

Aves
=======================================================================
Row {data-height=10}
-----------------------------------------------------------------------
### **Servicio ecosistémico de soporte: Hábitat para la biodiversidad (riqueza de especies). Fuente de los datos: [Infraestructura Global de Información en Biodiversidad (GBIF)](https://www.gbif.org/occurrence/download/0002762-200127171203522)**.

Row
-----------------------------------------------------------------------

### 

```{r}

plot_ly(data = df_registros_presencia_aves_agrupados_por_anyo,
        x = ~year,
        y = ~n,
        type = "bar",
        text = ~n, textposition = 'auto') %>%
  layout(
     title = paste("Registros de presencia de especies de aves detectadas desde el año 2000 (de un total de", especies_aves, "especies para ese período)"),
     xaxis = list(title = "Año"),
     yaxis = list(title = "Registros de presencia")
  ) %>%
  config(locale = 'es')

```

Anfibios
=======================================================================
Row {data-height=10}
-----------------------------------------------------------------------
### **Servicio ecosistémico de soporte: Hábitat para la biodiversidad (riqueza de especies). Fuente de los datos: [Infraestructura Global de Información en Biodiversidad (GBIF)](https://www.gbif.org/occurrence/download/0002762-200127171203522)**.

Row
-----------------------------------------------------------------------

### 

```{r}

plot_ly(data = df_registros_presencia_amphibia_agrupados_por_anyo,
        x = ~year,
        y = ~n,
        type = "bar",
        text = ~n, textposition = 'auto') %>%
  layout(
     title = paste("Registros de presencia de especies de anfibios detectadas desde el año 2000 (de un total de", especies_amphibia, "especies para ese período)"),
     xaxis = list(title = "Año"),
     yaxis = list(title = "Registros de presencia")
  ) %>%
  config(locale = 'es')

```